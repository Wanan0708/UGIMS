# ğŸ” ç®¡ç½‘ä¸æ˜¾ç¤ºé—®é¢˜æ’æŸ¥æŒ‡å—

**å½“å‰çŠ¶æ€**: ç®¡ç½‘åˆå§‹åŒ–ä»£ç å·²å¯ç”¨ï¼Œä½†ç•Œé¢ä¸Šæ²¡æœ‰æ˜¾ç¤ºç®¡ç½‘æ•°æ®

---

## ğŸ“‹ **æ’æŸ¥æ­¥éª¤**

### 1ï¸âƒ£ æ£€æŸ¥æ—¥å¿—æ–‡ä»¶

æŸ¥çœ‹ `logs/app.log` çš„æœ€åå†…å®¹ï¼š

```bash
# æŸ¥çœ‹æœ€å100è¡Œæ—¥å¿—
tail -n 100 logs/app.log
```

**å…³é”®ä¿¡æ¯ï¼š**
- æ˜¯å¦æœ‰ `[Pipeline]` å¼€å¤´çš„æ—¥å¿—ï¼Ÿ
- æ•°æ®åº“æ˜¯å¦è¿æ¥æˆåŠŸï¼Ÿ
- LayerManager æ˜¯å¦åˆ›å»ºæˆåŠŸï¼Ÿ
- æ˜¯å¦æœ‰ "Pipeline items rendered" æˆ– "Scene bounds is empty" æ¶ˆæ¯ï¼Ÿ

---

### 2ï¸âƒ£ æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰æ•°æ®

è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š

```bash
# ç¼–è¯‘å¹¶è¿è¡Œæ•°æ®åº“è¿æ¥æµ‹è¯•
qmake test_db.pro
mingw32-make
.\release\test_db_connection.exe
```

**é¢„æœŸè¾“å‡ºï¼š**
- æ˜¾ç¤ºæ•°æ®åº“ä¸­ç®¡ç½‘å’Œè®¾æ–½çš„æ•°é‡
- å¦‚æœä¸º 0ï¼Œè¯´æ˜æ•°æ®åº“ä¸­æ²¡æœ‰æ•°æ®

---

### 3ï¸âƒ£ æ£€æŸ¥çŠ¶æ€æ æ¶ˆæ¯

å¯åŠ¨ç¨‹åºåï¼Œè§‚å¯ŸçŠ¶æ€æ æ˜¾ç¤ºçš„æ¶ˆæ¯ï¼š

- **æ­£å¸¸æµç¨‹**ï¼š
  1. "æ­£åœ¨åˆå§‹åŒ–ç®¡ç½‘å¯è§†åŒ–..."
  2. "æ­£åœ¨è¿æ¥æ•°æ®åº“..."
  3. "æ­£åœ¨åŠ è½½ç®¡ç½‘æ•°æ®..."
  4. "ç®¡ç½‘æ•°æ®åŠ è½½å®Œæˆ" æˆ– "æœªæ‰¾åˆ°ç®¡ç½‘æ•°æ®"

- **å¼‚å¸¸æƒ…å†µ**ï¼š
  - "æ•°æ®åº“é…ç½®æœªæ‰¾åˆ°"
  - "æ•°æ®åº“è¿æ¥å¤±è´¥"
  - "å›¾å±‚ç®¡ç†å™¨åˆ›å»ºå¤±è´¥"

---

## ğŸ› **å¯èƒ½çš„åŸå› **

### åŸå›  1: æ•°æ®åº“ä¸­æ²¡æœ‰æ•°æ®

**ç°è±¡**: çŠ¶æ€æ æ˜¾ç¤º"æœªæ‰¾åˆ°ç®¡ç½‘æ•°æ®"

**è§£å†³æ–¹æ¡ˆ**: å¯¼å…¥æµ‹è¯•æ•°æ®

```bash
# ç¡®ä¿æ•°æ®åº“å·²åˆ›å»º
psql -U postgres -c "CREATE DATABASE ugims;"
psql -U postgres -d ugims -c "CREATE EXTENSION postgis;"

# å¯¼å…¥è¡¨ç»“æ„
psql -U postgres -d ugims -f database/schema.sql

# å¯¼å…¥æµ‹è¯•æ•°æ®
psql -U postgres -d ugims -f database/test_data.sql
```

---

### åŸå›  2: åæ ‡ç³»ç»Ÿä¸åŒ¹é…

**ç°è±¡**: 
- æ—¥å¿—æ˜¾ç¤º "Pipeline items rendered"
- ä½†ç•Œé¢ä¸Šçœ‹ä¸åˆ°ç®¡ç½‘

**åŸå› **: 
- æµ‹è¯•æ•°æ®åæ ‡åœ¨åŒ—äº¬ï¼ˆ116.39-116.42, 39.90-39.92ï¼‰
- åœ°å›¾å¯èƒ½æ˜¾ç¤ºçš„æ˜¯å…¶ä»–ä½ç½®

**è§£å†³æ–¹æ¡ˆ**: è°ƒæ•´åœ°å›¾åˆ°åŒ—äº¬åŒºåŸŸ

åœ¨ `src/ui/myform.cpp` çš„ `setupMapArea()` ä¸­æ·»åŠ ï¼š

```cpp
// å°†åœ°å›¾ä¸­å¿ƒè®¾ç½®ä¸ºåŒ—äº¬å¤©å®‰é—¨
tileMapManager->setCenterLatLon(39.91, 116.40);
tileMapManager->setZoom(15);  // æ”¾å¤§åˆ°èƒ½çœ‹æ¸…ç®¡ç½‘çš„çº§åˆ«
```

---

### åŸå›  3: ç®¡ç½‘å›¾å±‚ Z å€¼å¤ªä½

**ç°è±¡**: ç®¡ç½‘è¢«åœ°å›¾ç“¦ç‰‡é®æŒ¡

**æ£€æŸ¥**: åœ¨ `src/map/pipelinerenderer.cpp` ä¸­ç¡®è®¤ï¼š

```cpp
// 6. è®¾ç½®Zå€¼ï¼ˆç¡®ä¿åœ¨åº•å›¾ä¹‹ä¸Šï¼‰
item->setZValue(10);  // âœ… åº”è¯¥å¤§äº0
```

---

### åŸå›  4: ç®¡ç½‘æ¸²æŸ“åˆ°äº†é”™è¯¯çš„åœºæ™¯åæ ‡

**ç°è±¡**: 
- æœ‰æ—¥å¿—æ˜¾ç¤ºæ¸²æŸ“æˆåŠŸ
- ä½† scene bounds éå¸¸å¤§æˆ–éå¸¸å°

**è°ƒè¯•ä»£ç **:

åœ¨ `src/map/pipelinerenderer.cpp` çš„ `renderPipeline()` ä¸­æ·»åŠ è°ƒè¯•ï¼š

```cpp
// åœ¨åˆ›å»ºè·¯å¾„åæ·»åŠ 
qDebug() << "[Pipeline] Rendering" << pipeline.pipelineId() 
         << "from" << coords[0] << "to" << coords[coords.size()-1];
qDebug() << "[Pipeline] Scene coords:" << firstPoint << "to" << geoToScene(coords[coords.size()-1]);
```

é‡æ–°ç¼–è¯‘å¹¶æŸ¥çœ‹è¾“å‡ºåæ ‡æ˜¯å¦åˆç†ï¼ˆåº”è¯¥åœ¨åœºæ™¯èŒƒå›´å†…ï¼‰ã€‚

---

## ğŸ”§ **å¿«é€Ÿä¿®å¤**

### æ–¹æ³• 1: ç¡®ä¿åœ°å›¾æ˜¾ç¤ºåŒ—äº¬åŒºåŸŸ

ä¿®æ”¹ `src/ui/myform.cpp`:

```cpp
void MyForm::loadPipelineData()
{
    if (!m_layerManager) {
        LOG_WARNING("LayerManager not initialized, skipping pipeline data load");
        return;
    }
    
    LOG_INFO("Loading pipeline data from database");
    updateStatus("æ­£åœ¨åŠ è½½ç®¡ç½‘æ•°æ®...");
    
    // æµ‹è¯•æ•°æ®èŒƒå›´: ç»åº¦ 116.39-116.42, çº¬åº¦ 39.90-39.92
    QRectF geoBounds(
        116.390,  // æœ€å°ç»åº¦
        39.900,   // æœ€å°çº¬åº¦
        0.030,    // å®½åº¦ï¼ˆç»åº¦è·¨åº¦ï¼‰
        0.020     // é«˜åº¦ï¼ˆçº¬åº¦è·¨åº¦ï¼‰
    );
    
    // âœ… å…ˆå°†åœ°å›¾ç§»åŠ¨åˆ°æµ‹è¯•æ•°æ®åŒºåŸŸ
    if (tileMapManager) {
        tileMapManager->setCenterLatLon(39.91, 116.40);
        // å¦‚æœå½“å‰zoomå¤ªå°ï¼Œé€‚å½“æ”¾å¤§
        if (currentZoomLevel < 13) {
            currentZoomLevel = 15;
            tileMapManager->setZoom(currentZoomLevel);
        }
    }
    
    // è®¾ç½®å¯è§†èŒƒå›´
    m_layerManager->setVisibleBounds(geoBounds);
    
    // åˆ·æ–°æ‰€æœ‰å¯è§å›¾å±‚
    m_layerManager->refreshAllLayers();
    
    LOG_INFO("Pipeline layers refreshed");
    
    // å»¶è¿Ÿæ£€æŸ¥æ¸²æŸ“ç»“æœ
    QTimer::singleShot(500, this, [this]() {
        if (mapScene && ui->graphicsView) {
            QRectF sceneBounds = mapScene->itemsBoundingRect();
            if (!sceneBounds.isEmpty()) {
                int itemCount = mapScene->items().size();
                LOG_INFO(QString("Scene has %1 items, bounds: [%2, %3, %4, %4]")
                             .arg(itemCount)
                             .arg(sceneBounds.left()).arg(sceneBounds.top())
                             .arg(sceneBounds.width()).arg(sceneBounds.height()));
                updateStatus(QString("ç®¡ç½‘æ•°æ®åŠ è½½å®Œæˆ (%1 ä¸ªå¯¹è±¡)").arg(itemCount));
            } else {
                LOG_WARNING("Scene bounds is empty, no items rendered");
                updateStatus("æœªæ‰¾åˆ°ç®¡ç½‘æ•°æ®");
            }
        }
    });
}
```

---

### æ–¹æ³• 2: å¢åŠ è°ƒè¯•ä¿¡æ¯

ä¿®æ”¹ `src/map/pipelinerenderer.cpp`:

```cpp
void PipelineRenderer::renderPipelines(QGraphicsScene *scene, 
                                      const QString &pipelineType,
                                      const QRectF &bounds)
{
    if (!scene) {
        LOG_WARNING("Cannot render pipelines: scene is null");
        return;
    }
    
    LOG_INFO(QString("Rendering pipelines of type: %1").arg(pipelineType));
    qDebug() << "[Pipeline] Query bounds:" << bounds;
    qDebug() << "[Pipeline] TileMapManager:" << (m_tileMapManager ? "SET" : "NULL");
    qDebug() << "[Pipeline] Current zoom:" << m_zoom;
    
    // 1. ä»æ•°æ®åº“åŠ è½½ç®¡çº¿æ•°æ®
    QVector<Pipeline> pipelines;
    
    if (bounds.isValid() && !bounds.isEmpty()) {
        pipelines = m_pipelineDao->findByBounds(bounds);
        LOG_INFO(QString("Loaded %1 pipelines in bounds").arg(pipelines.size()));
        qDebug() << "[Pipeline] Found" << pipelines.size() << "pipelines in database";
    } else {
        pipelines = m_pipelineDao->findByType(pipelineType, 1000);
        LOG_INFO(QString("Loaded %1 pipelines of type %2")
                     .arg(pipelines.size()).arg(pipelineType));
        qDebug() << "[Pipeline] Found" << pipelines.size() << "pipelines of type" << pipelineType;
    }
    
    if (pipelines.isEmpty()) {
        LOG_WARNING(QString("No pipelines found for type: %1").arg(pipelineType));
        qDebug() << "[Pipeline] âš ï¸  No data in database!";
        return;
    }
    
    // ... ç»§ç»­æ¸²æŸ“
}
```

---

## ğŸ¯ **è¯Šæ–­å‘½ä»¤**

åˆ›å»ºä¸€ä¸ªå¿«é€Ÿæµ‹è¯•è„šæœ¬ `test_pipeline_display.bat`:

```batch
@echo off
echo ========================================
echo ç®¡ç½‘æ˜¾ç¤ºé—®é¢˜è¯Šæ–­
echo ========================================
echo.

echo [1/4] æ£€æŸ¥æ•°æ®åº“è¿æ¥...
psql -U postgres -d ugims -c "SELECT COUNT(*) as pipeline_count FROM pipelines;"
echo.

echo [2/4] æ£€æŸ¥ç®¡ç½‘æ•°æ®...
psql -U postgres -d ugims -c "SELECT pipeline_type, COUNT(*) FROM pipelines GROUP BY pipeline_type;"
echo.

echo [3/4] æ£€æŸ¥åæ ‡èŒƒå›´...
psql -U postgres -d ugims -c "SELECT ST_Extent(geom) FROM pipelines;"
echo.

echo [4/4] æ£€æŸ¥æ—¥å¿—ï¼ˆæœ€å20è¡Œï¼‰...
tail -n 20 logs/app.log
echo.

echo è¯Šæ–­å®Œæˆï¼
pause
```

---

## âœ… **æ£€æŸ¥æ¸…å•**

- [ ] æ•°æ®åº“ `ugims` æ˜¯å¦å­˜åœ¨ï¼Ÿ
- [ ] æ•°æ®åº“ä¸­æ˜¯å¦æœ‰ç®¡ç½‘æ•°æ®ï¼Ÿ
- [ ] æ—¥å¿—ä¸­æ˜¯å¦æœ‰æ•°æ®åº“è¿æ¥æˆåŠŸæ¶ˆæ¯ï¼Ÿ
- [ ] æ—¥å¿—ä¸­æ˜¯å¦æœ‰ "LayerManager created" æ¶ˆæ¯ï¼Ÿ
- [ ] æ—¥å¿—ä¸­æ˜¯å¦æœ‰ "Found X pipelines" æ¶ˆæ¯ï¼Ÿ
- [ ] çŠ¶æ€æ æ˜¾ç¤ºä»€ä¹ˆæ¶ˆæ¯ï¼Ÿ
- [ ] åœ°å›¾å½“å‰æ˜¾ç¤ºçš„æ˜¯å“ªä¸ªåŒºåŸŸï¼Ÿ
- [ ] åœ°å›¾ç¼©æ”¾çº§åˆ«æ˜¯å¤šå°‘ï¼Ÿï¼ˆZoom 10 å¤ªå°ï¼Œå»ºè®® 15ï¼‰

---

**è¯·å…ˆè¿è¡Œç¨‹åºï¼Œç„¶åå‘Šè¯‰æˆ‘ï¼š**
1. çŠ¶æ€æ æœ€åæ˜¾ç¤ºä»€ä¹ˆï¼Ÿ
2. `logs/app.log` æœ€åå‡ è¡Œæ˜¯ä»€ä¹ˆå†…å®¹ï¼Ÿ
3. åœ°å›¾å½“å‰æ˜¾ç¤ºçš„æ˜¯å“ªä¸ªåŸå¸‚/åŒºåŸŸï¼Ÿ
4. åœ°å›¾ç¼©æ”¾çº§åˆ«æ˜¾ç¤ºæ˜¯å¤šå°‘ï¼Ÿ

è¿™æ ·æˆ‘æ‰èƒ½å‡†ç¡®å®šä½é—®é¢˜ï¼ğŸ¯

