# 消息和个人信息功能设计方案

## 📋 功能概述

### 1. 消息功能（MessageDialog）
- 显示系统消息和通知列表
- 支持消息分类（系统通知、工单通知、警告等）
- 支持标记已读/未读
- 支持删除消息
- 实时更新未读消息数量，更新按钮图标

### 2. 个人信息功能（ProfileDialog）
- 显示当前登录用户的基本信息
- 允许修改个人信息（真实姓名、邮箱、电话等）
- 修改密码功能
- 显示登录历史记录
- 显示权限信息

---

## 🎨 界面设计

### 消息对话框（MessageDialog）

#### 布局结构
```
┌─────────────────────────────────────────┐
│  消息中心                    [关闭]     │
├─────────────────────────────────────────┤
│ [全部] [未读] [系统] [工单] [警告]     │
├─────────────────────────────────────────┤
│ ┌─────────────────────────────────────┐ │
│ │ 📢 系统通知                          │ │
│ │ 您有新的工单需要处理                 │ │
│ │ 2025-01-27 10:30                    │ │
│ └─────────────────────────────────────┘ │
│ ┌─────────────────────────────────────┐ │
│ │ ⚠️  警告                            │ │
│ │ 管线 P001 健康度低于阈值             │ │
│ │ 2025-01-27 09:15                    │ │
│ └─────────────────────────────────────┘ │
│                                         │
├─────────────────────────────────────────┤
│ [标记全部已读] [删除已读] [刷新] [关闭] │
└─────────────────────────────────────────┘
```

#### 功能特性
- **消息列表**：使用 QListWidget 显示消息列表
- **分类筛选**：顶部按钮切换不同消息类型
- **消息项**：显示图标、标题、内容、时间
- **未读标识**：未读消息显示粗体或不同颜色
- **操作按钮**：标记已读、删除、刷新

### 个人信息对话框（ProfileDialog）

#### 布局结构
```
┌─────────────────────────────────────────┐
│  个人信息                    [关闭]     │
├─────────────────────────────────────────┤
│ ┌─ 基本信息 ─────────────────────────┐ │
│ │ 用户名: admin (只读)                │ │
│ │ 真实姓名: [张三        ]            │ │
│ │ 邮箱: [zhang@example.com]          │ │
│ │ 电话: [13800138000]                │ │
│ │ 部门: [技术部        ]              │ │
│ │ 组织: [XX公司        ]              │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─ 账户信息 ─────────────────────────┐ │
│ │ 角色: 管理员 (只读)                  │ │
│ │ 状态: 激活 (只读)                    │ │
│ │ 创建时间: 2024-01-01 (只读)         │ │
│ │ 最后登录: 2025-01-27 10:00 (只读)   │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─ 修改密码 ─────────────────────────┐ │
│ │ 当前密码: [********]                │ │
│ │ 新密码:   [********]                │ │
│ │ 确认密码: [********]                │ │
│ │ [修改密码]                          │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─ 权限信息 ─────────────────────────┐ │
│ │ ✓ 数据管理                           │ │
│ │ ✓ 工单管理                           │ │
│ │ ✓ 用户管理                           │ │
│ └─────────────────────────────────────┘ │
│                                         │
├─────────────────────────────────────────┤
│ [保存] [取消]                           │
└─────────────────────────────────────────┘
```

#### 功能特性
- **基本信息编辑**：可修改真实姓名、邮箱、电话、部门、组织
- **账户信息显示**：角色、状态、时间等只读信息
- **密码修改**：独立的密码修改区域
- **权限显示**：列出当前用户的所有权限

---

## 🗄️ 数据库设计

### 消息表（notifications）

```sql
CREATE TABLE notifications (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    message_type VARCHAR(50) NOT NULL,  -- system, workorder, warning, info
    title VARCHAR(200) NOT NULL,
    content TEXT,
    is_read BOOLEAN DEFAULT FALSE,
    related_id VARCHAR(50),  -- 关联的工单ID、资产ID等
    related_type VARCHAR(50),  -- workorder, pipeline, facility等
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    read_at TIMESTAMP
);

CREATE INDEX idx_notifications_user ON notifications(user_id);
CREATE INDEX idx_notifications_read ON notifications(is_read);
CREATE INDEX idx_notifications_type ON notifications(message_type);
CREATE INDEX idx_notifications_created ON notifications(created_at);
```

---

## 🔧 实现方案

### 1. 消息对话框（MessageDialog）

#### 文件结构
- `src/widgets/messagedialog.h`
- `src/widgets/messagedialog.cpp`

#### 主要功能
- `loadMessages()` - 从数据库加载消息
- `filterMessages()` - 根据类型筛选消息
- `markAsRead()` - 标记消息为已读
- `deleteMessage()` - 删除消息
- `getUnreadCount()` - 获取未读消息数量

#### 消息类型
- **system**: 系统通知（蓝色图标）
- **workorder**: 工单通知（橙色图标）
- **warning**: 警告消息（红色图标）
- **info**: 普通信息（灰色图标）

### 2. 个人信息对话框（ProfileDialog）

#### 文件结构
- `src/widgets/profiledialog.h`
- `src/widgets/profiledialog.cpp`

#### 主要功能
- `loadUserInfo()` - 加载当前用户信息
- `saveUserInfo()` - 保存修改的用户信息
- `changePassword()` - 修改密码
- `validateInput()` - 验证输入

#### 数据来源
- 使用 `SessionManager::currentUser()` 获取当前用户
- 使用 `UserDAO` 更新用户信息

### 3. 消息服务（NotificationService）

#### 文件结构
- `src/core/notification/notificationservice.h`
- `src/core/notification/notificationservice.cpp`
- `src/dao/notificationdao.h`
- `src/dao/notificationdao.cpp`

#### 主要功能
- `createNotification()` - 创建消息
- `getUnreadCount()` - 获取未读数量
- `markAsRead()` - 标记已读
- `deleteNotification()` - 删除消息

---

## 🔄 集成方案

### 1. 在主窗口中集成

#### 消息按钮
- 点击打开消息对话框
- 实时显示未读消息数量（在按钮上显示徽章）
- 根据未读消息数量切换图标（Message.png / NoMessage.png）

#### 个人信息按钮
- 点击打开个人信息对话框
- 显示当前用户头像或名称

### 2. 消息更新机制

#### 实时更新
- 使用定时器定期检查新消息（每30秒）
- 工单状态变更时自动创建消息
- 系统事件触发消息创建

#### 消息创建场景
- 工单分配：创建工单通知
- 工单完成：创建完成通知
- 资产健康度警告：创建警告消息
- 系统维护：创建系统通知

---

## 📝 实现步骤

### 第一阶段：基础框架
1. ✅ 创建消息对话框 UI
2. ✅ 创建个人信息对话框 UI
3. ✅ 创建数据库表（notifications）
4. ✅ 创建 NotificationDAO

### 第二阶段：核心功能
1. ✅ 实现消息加载和显示
2. ✅ 实现消息筛选和操作
3. ✅ 实现个人信息编辑
4. ✅ 实现密码修改

### 第三阶段：集成和优化
1. ✅ 集成到主窗口
2. ✅ 实现消息实时更新
3. ✅ 实现未读消息计数
4. ✅ 优化用户体验

---

## 🎯 用户体验优化

### 消息功能
- **未读消息提示**：按钮上显示红色徽章，显示未读数量
- **消息预览**：鼠标悬停显示消息内容预览
- **快速操作**：右键菜单快速标记已读/删除
- **声音提醒**：新消息到达时播放提示音（可选）

### 个人信息功能
- **输入验证**：实时验证邮箱格式、电话格式等
- **密码强度**：显示密码强度指示器
- **修改确认**：重要信息修改时要求确认密码
- **操作反馈**：保存成功后显示提示

---

**设计日期**: 2025-01-27

