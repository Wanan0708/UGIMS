# 程序启动时自动加载数据库设备数据

## ✅ 已完成的改进

### 启动流程优化

程序启动时会自动执行以下步骤：

1. **地图初始化**（延迟10ms）
   - 初始化地图场景和视图

2. **管网可视化初始化**（延迟30ms）
   - 连接数据库
   - 创建图层管理器
   - 设置坐标系统

3. **自动加载数据**（延迟2秒）
   - 等待地图视图完全初始化
   - 根据当前地图视图范围计算地理边界
   - 从数据库加载该范围内的所有设备数据
   - 加载用户绘制的数据

---

## 🔧 实现细节

### `loadPipelineData()` 函数改进

**改进前：**
- 使用固定的测试数据范围（北京天安门区域）
- 只加载图层数据，不加载用户绘制数据

**改进后：**
- ✅ **智能计算视图范围**：根据当前地图视图自动计算地理边界
- ✅ **加载所有数据**：同时加载图层数据和用户绘制数据
- ✅ **容错处理**：如果地图未初始化，使用默认范围

**实现逻辑：**
```cpp
1. 检查图层管理器是否初始化
2. 如果地图已初始化：
   - 获取视图的可见矩形（场景坐标）
   - 转换为地理坐标
   - 计算地理范围
3. 如果地图未初始化：
   - 使用默认范围（北京天安门区域）
4. 设置可视范围并刷新所有图层
5. 加载用户绘制的数据
```

---

## 📊 数据加载范围

### 自动计算视图范围

程序会根据当前地图视图自动计算需要加载的数据范围：

- **经度范围**：根据视图左右边界计算
- **纬度范围**：根据视图上下边界计算
- **动态调整**：地图缩放或移动后，刷新按钮会重新计算范围

### 默认范围（地图未初始化时）

- **经度**：116.390 - 116.420（北京天安门区域）
- **纬度**：39.900 - 39.920

---

## 🚀 启动流程时间线

```
0ms     - 程序启动
10ms    - 地图初始化开始
30ms    - 管网可视化初始化开始
         ├─ 连接数据库
         ├─ 创建图层管理器
         └─ 设置坐标系统
2000ms  - 自动加载数据
         ├─ 计算视图范围
         ├─ 加载图层数据
         └─ 加载用户绘制数据
```

---

## 💡 使用说明

### 自动加载

程序启动后，会自动：
1. 连接数据库
2. 根据当前地图视图范围加载设备数据
3. 在地图上显示所有管线和设施

### 手动刷新

如果需要刷新数据：
- 点击"刷新"按钮（F5）
- 系统会重新计算当前视图范围
- 重新加载该范围内的所有数据

---

## 🔍 技术要点

### 坐标转换

- **场景坐标** → **地理坐标**：使用 `TileMapManager::sceneToGeo()`
- **地理坐标** → **场景坐标**：使用 `TileMapManager::geoToScene()`

### 视图范围计算

```cpp
// 获取视图可见矩形（场景坐标）
QRectF viewportRect = graphicsView->mapToScene(
    graphicsView->viewport()->rect()
).boundingRect();

// 转换为地理坐标
QPointF topLeft = tileMapManager->sceneToGeo(viewportRect.topLeft(), zoom);
QPointF bottomRight = tileMapManager->sceneToGeo(viewportRect.bottomRight(), zoom);

// 计算地理范围
QRectF geoBounds(minLon, minLat, width, height);
```

### 数据加载

- **图层数据**：通过 `LayerManager::refreshAllLayers()` 加载
- **用户绘制数据**：通过 `DrawingDatabaseManager::loadFromDatabase()` 加载

---

## ✅ 改进效果

1. **自动加载**：程序启动后自动显示数据库中的设备
2. **智能范围**：根据实际地图视图范围加载，不浪费资源
3. **完整数据**：同时加载图层数据和用户绘制数据
4. **用户体验**：无需手动操作，数据自动显示

---

**最后更新**: 2025-01-27

