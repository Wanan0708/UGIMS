# 连通性分析和爆管分析功能测试指南

## 一、功能需求说明

### 1. 爆管分析功能

#### 功能描述
爆管分析用于模拟和分析管线爆管后的影响范围，帮助制定应急响应方案。

#### 核心功能
1. **爆管点定位**
   - 自动查找爆管点附近的管线
   - 识别爆管管线的基本信息（ID、类型、管径）

2. **影响范围分析**
   - 查找需要关闭的阀门列表（用于隔离爆管区域）
   - 追踪受影响的连通管线
   - 计算受影响区域（多边形）
   - 计算受影响面积（平方米）

3. **影响评估**
   - 估算受影响用户数（基于用户密度）
   - 计算受影响管线总长度
   - 评估维修优先级（1-5级，5为最高）
   - 估算预计维修时间（小时）

4. **应急建议**
   - 生成建议操作步骤
   - 提供应急联系人信息

#### 可视化显示
- **红色虚线区域框**：显示受影响区域范围
- **红色高亮管线**：显示受影响的管线
- **橙色高亮设施**：显示需要关闭的阀门
- **红色爆管点标记**：显示爆管位置，带坐标标签

---

### 2. 连通性分析功能

#### 功能描述
连通性分析用于分析管网的连通性，追踪管线的上下游关系，查找路径。

#### 核心功能类型

##### 2.1 上游追踪
- **功能**：从指定点追溯到源头（如水厂、泵站）
- **算法**：使用BFS（广度优先搜索）算法
- **输出**：
  - 路径上的所有管线ID列表
  - 路径总长度（米）
  - 节点数量
  - 是否连通

##### 2.2 下游追踪
- **功能**：从指定点追踪到末端（如污水处理厂、用户）
- **算法**：使用BFS（广度优先搜索）算法
- **输出**：
  - 路径上的所有管线ID列表
  - 路径总长度（米）
  - 节点数量
  - 是否连通

##### 2.3 最短路径
- **功能**：查找两点间的最短路径
- **算法**：使用Dijkstra算法
- **输入**：起点和终点（需要点击两次地图）
- **输出**：
  - 最短路径上的管线ID列表
  - 路径总长度（米）
  - 路径节点数量

#### 可视化显示
- **蓝色高亮**：上游追踪结果
- **橙色高亮**：下游追踪结果
- **绿色高亮**：最短路径结果
- **起点标记**：蓝色/橙色/绿色圆点标记起点
- **终点标记**：红色圆点标记终点（最短路径）

---

## 二、测试前准备

### 1. 数据库准备
- ✅ 确保数据库已连接
- ✅ 数据库中需要有管线数据（`pipelines` 表）
- ✅ 数据库中需要有设施数据（`facilities` 表，特别是阀门数据）
- ✅ 管线数据需要包含坐标信息（`geometry` 字段）
- ✅ 设施数据需要包含坐标信息（`coordinate` 字段）

### 2. 测试数据要求
- **管线数据**：
  - 至少需要2-3条相互连接的管线
  - 管线需要有正确的坐标信息
  - 管线之间需要在端点处连接（容差5米）

- **设施数据**：
  - 至少需要1-2个阀门设施
  - 阀门需要与管线关联（`pipeline_id` 字段）
  - 阀门需要有正确的坐标信息

### 3. 地图准备
- ✅ 地图已加载并显示
- ✅ 管线和设施已在地图上渲染显示
- ✅ 可以正常缩放和拖拽地图

---

## 三、爆管分析测试用例

### 测试用例 1：基本爆管分析流程

#### 测试步骤
1. **启动爆管分析**
   - 点击"爆管分析"按钮
   - ✅ 检查：状态栏显示"爆管分析：请选择爆管点（左键确认，右键/ESC 取消）"
   - ✅ 检查：鼠标光标变为十字光标
   - ✅ 检查：功能区按钮被禁用（避免误操作）

2. **选择爆管点**
   - 在地图上点击一个位置（建议点击在管线上或附近）
   - ✅ 检查：弹出"爆管分析结果"对话框
   - ✅ 检查：对话框中显示以下信息：
     - 爆管位置（经纬度）
     - 爆管管线ID
     - 管径
     - 需关闭阀门列表
     - 受影响管线列表
     - 影响面积
     - 估算影响用户数
     - 预计维修时长
     - 建议操作
     - 应急联系人

3. **检查可视化结果**
   - ✅ 检查：地图上显示红色虚线区域框（受影响区域）
   - ✅ 检查：受影响的管线以红色高亮显示
   - ✅ 检查：需要关闭的阀门以橙色高亮显示
   - ✅ 检查：爆管点位置显示红色圆点标记，带"爆管点"标签和坐标

4. **继续分析**
   - 再次点击地图上的其他位置
   - ✅ 检查：执行新的爆管分析
   - ✅ 检查：旧的分析结果被清除，显示新的结果

5. **取消分析模式**
   - 右键点击地图或按ESC键
   - ✅ 检查：状态栏显示"已取消爆管点选择"
   - ✅ 检查：鼠标光标恢复为箭头
   - ✅ 检查：所有爆管分析相关的可视化元素被清除（区域框、高亮管线、爆管点标记）
   - ✅ 检查：功能区按钮恢复可用

#### 预期结果
- ✅ 能够成功执行爆管分析
- ✅ 分析结果准确显示
- ✅ 可视化效果正确
- ✅ 可以多次分析不同位置
- ✅ 可以正常取消分析模式

---

### 测试用例 2：爆管分析边界情况

#### 测试步骤
1. **点击空白区域**
   - 在地图空白处点击
   - ✅ 检查：如果找不到附近管线，显示"爆管分析失败"警告
   - ✅ 检查：状态栏提示可以继续选择爆管点

2. **点击管线边缘**
   - 点击管线的边缘位置
   - ✅ 检查：能够正确识别管线
   - ✅ 检查：不会触发管线选中（不会显示金色高亮框）

3. **数据库未连接**
   - 断开数据库连接
   - 点击"爆管分析"按钮
   - ✅ 检查：提示"需要连接数据库才能执行爆管分析"

#### 预期结果
- ✅ 边界情况处理正确
- ✅ 错误提示清晰
- ✅ 不会崩溃或出现异常

---

### 测试用例 3：爆管分析交互测试

#### 测试步骤
1. **分析后执行其他操作**
   - 执行爆管分析
   - 尝试点击管线
   - ✅ 检查：管线不会被选中（不会显示金色高亮框）
   - ✅ 检查：可以继续点击地图执行新的爆管分析

2. **分析后执行连通性分析**
   - 执行爆管分析
   - 取消爆管分析模式
   - 执行连通性分析
   - ✅ 检查：爆管分析的可视化结果被清除
   - ✅ 检查：连通性分析可以正常执行

3. **多次切换分析模式**
   - 执行爆管分析 → 取消
   - 执行连通性分析 → 取消
   - 再次执行爆管分析
   - ✅ 检查：每次切换都能正确清除之前的结果
   - ✅ 检查：不会出现残留的可视化元素

#### 预期结果
- ✅ 不同分析模式之间不会相互干扰
- ✅ 状态切换正确
- ✅ 可视化元素正确清除

---

## 四、连通性分析测试用例

### 测试用例 4：上游追踪

#### 测试步骤
1. **启动上游追踪**
   - 点击"连通性分析"按钮
   - ✅ 检查：弹出选择分析类型对话框
   - 选择"上游追踪"
   - ✅ 检查：状态栏显示"上游追踪：请选择起点（左键确认，右键/ESC 取消）"
   - ✅ 检查：鼠标光标变为十字光标

2. **选择起点**
   - 在地图上点击一个位置（建议点击在管线上）
   - ✅ 检查：弹出"连通性分析结果"对话框
   - ✅ 检查：对话框中显示以下信息：
     - 分析类型：上游追踪
     - 起点位置（经纬度）
     - 追踪深度（节点数量）
     - 路径管线数
     - 路径总长度（米）
     - 是否连通
     - 路径管线列表

3. **检查可视化结果**
   - ✅ 检查：路径上的管线以蓝色高亮显示
   - ✅ 检查：起点位置显示蓝色圆点标记

4. **继续分析**
   - 再次点击地图上的其他位置
   - ✅ 检查：执行新的上游追踪
   - ✅ 检查：旧的结果被清除，显示新的结果

5. **取消分析模式**
   - 右键点击地图或按ESC键
   - ✅ 检查：状态栏显示"已取消连通性分析"
   - ✅ 检查：所有可视化元素被清除

#### 预期结果
- ✅ 能够成功执行上游追踪
- ✅ 追踪结果准确
- ✅ 可视化效果正确（蓝色高亮）

---

### 测试用例 5：下游追踪

#### 测试步骤
1. **启动下游追踪**
   - 点击"连通性分析"按钮
   - 选择"下游追踪"
   - ✅ 检查：状态栏显示"下游追踪：请选择起点（左键确认，右键/ESC 取消）"

2. **选择起点并检查结果**
   - 在地图上点击一个位置
   - ✅ 检查：弹出分析结果对话框
   - ✅ 检查：路径上的管线以橙色高亮显示
   - ✅ 检查：起点位置显示橙色圆点标记

#### 预期结果
- ✅ 下游追踪功能正常
- ✅ 可视化效果正确（橙色高亮）

---

### 测试用例 6：最短路径

#### 测试步骤
1. **启动最短路径分析**
   - 点击"连通性分析"按钮
   - 选择"最短路径"
   - ✅ 检查：状态栏显示"最短路径分析：请先选择起点（左键确认起点，右键/ESC 取消）"

2. **选择起点**
   - 在地图上点击第一个位置
   - ✅ 检查：状态栏更新为"最短路径分析：请选择终点（左键确认终点，右键/ESC 取消）"
   - ✅ 检查：起点位置显示绿色圆点标记

3. **选择终点**
   - 在地图上点击第二个位置
   - ✅ 检查：弹出分析结果对话框
   - ✅ 检查：显示最短路径信息
   - ✅ 检查：路径上的管线以绿色高亮显示
   - ✅ 检查：起点显示绿色圆点，终点显示红色圆点

4. **取消分析**
   - 在只选择了起点时，右键点击或按ESC
   - ✅ 检查：取消分析模式，清除起点标记

#### 预期结果
- ✅ 最短路径分析功能正常
- ✅ 需要两个点才能完成分析
- ✅ 可视化效果正确（绿色高亮）

---

### 测试用例 7：连通性分析边界情况

#### 测试步骤
1. **点击空白区域**
   - 在地图空白处点击
   - ✅ 检查：如果找不到连通路径，显示"分析失败"警告
   - ✅ 检查：状态栏提示可以继续选择起点

2. **孤立管线**
   - 选择一个没有连接的管线作为起点
   - ✅ 检查：分析结果中"是否连通"为"否"
   - ✅ 检查：路径管线列表为空或只有起点管线

3. **数据库未连接**
   - 断开数据库连接
   - 点击"连通性分析"按钮
   - ✅ 检查：提示"连通性分析需要数据库连接"

#### 预期结果
- ✅ 边界情况处理正确
- ✅ 错误提示清晰

---

## 五、综合测试用例

### 测试用例 8：功能切换测试

#### 测试步骤
1. **爆管分析 → 连通性分析**
   - 执行爆管分析
   - 取消爆管分析模式
   - 执行连通性分析（上游追踪）
   - ✅ 检查：爆管分析的可视化结果被清除
   - ✅ 检查：连通性分析正常执行

2. **连通性分析 → 爆管分析**
   - 执行连通性分析（上游追踪）
   - 取消连通性分析模式
   - 执行爆管分析
   - ✅ 检查：连通性分析的可视化结果被清除
   - ✅ 检查：爆管分析正常执行

3. **多次快速切换**
   - 快速切换不同的分析模式
   - ✅ 检查：不会出现状态混乱
   - ✅ 检查：不会出现残留的可视化元素

#### 预期结果
- ✅ 功能切换流畅
- ✅ 状态管理正确
- ✅ 不会出现冲突

---

### 测试用例 9：性能测试

#### 测试步骤
1. **大数据量测试**
   - 使用包含大量管线（100+条）的数据库
   - 执行爆管分析
   - ✅ 检查：分析在合理时间内完成（<5秒）
   - ✅ 检查：不会出现界面卡顿

2. **复杂网络测试**
   - 使用包含复杂管网结构的数据库
   - 执行连通性分析（上游追踪）
   - ✅ 检查：追踪结果正确
   - ✅ 检查：不会出现无限循环或栈溢出

#### 预期结果
- ✅ 性能表现良好
- ✅ 不会出现性能问题

---

## 六、测试检查清单

### 功能完整性检查

#### 爆管分析
- [ ] 能够启动爆管分析模式
- [ ] 能够选择爆管点
- [ ] 能够显示分析结果对话框
- [ ] 能够显示受影响区域（红色虚线框）
- [ ] 能够高亮显示受影响管线（红色）
- [ ] 能够高亮显示需要关闭的阀门（橙色）
- [ ] 能够显示爆管点标记（红色圆点+标签）
- [ ] 能够多次执行分析
- [ ] 能够取消分析模式
- [ ] 取消时清除所有可视化元素

#### 连通性分析
- [ ] 能够启动连通性分析模式
- [ ] 能够选择分析类型（上游/下游/最短路径）
- [ ] 上游追踪功能正常（蓝色高亮）
- [ ] 下游追踪功能正常（橙色高亮）
- [ ] 最短路径功能正常（绿色高亮，需要两个点）
- [ ] 能够显示分析结果对话框
- [ ] 能够显示起点/终点标记
- [ ] 能够多次执行分析
- [ ] 能够取消分析模式
- [ ] 取消时清除所有可视化元素

### 交互测试检查
- [ ] 分析模式下不会意外选中管线（不显示金色高亮框）
- [ ] 不同分析模式之间不会相互干扰
- [ ] 状态切换正确
- [ ] 错误处理正确（数据库未连接、找不到数据等）
- [ ] 边界情况处理正确

### 性能检查
- [ ] 分析响应时间合理（<5秒）
- [ ] 大数据量下不会卡顿
- [ ] 复杂网络下不会出现无限循环

---

## 七、常见问题排查

### 问题1：爆管分析找不到管线
**可能原因**：
- 数据库中没有管线数据
- 点击位置距离管线太远（超过搜索半径）
- 管线坐标数据不正确

**解决方法**：
- 检查数据库中是否有管线数据
- 尝试点击更靠近管线的位置
- 检查管线数据的geometry字段是否正确

### 问题2：连通性分析找不到路径
**可能原因**：
- 选择的起点没有连接的管线
- 管线之间没有正确连接（端点距离超过容差5米）
- 网络结构不完整

**解决方法**：
- 检查管线数据，确保管线之间有连接关系
- 检查管线端点坐标，确保连接点距离在5米容差内
- 尝试选择其他位置作为起点

### 问题3：可视化元素不显示
**可能原因**：
- 地图缩放级别不合适
- 可视化元素的Z值设置问题
- 场景渲染问题

**解决方法**：
- 调整地图缩放级别
- 检查代码中Z值的设置
- 刷新地图视图

### 问题4：分析结果不准确
**可能原因**：
- 数据库中的数据不完整
- 坐标系统不一致
- 算法参数设置不当

**解决方法**：
- 检查数据库数据的完整性
- 确保坐标系统一致（经纬度）
- 检查算法参数（搜索半径、容差等）

---

## 八、测试报告模板

### 测试环境
- **操作系统**：Windows 10
- **数据库**：MySQL/PostgreSQL
- **测试数据**：XX条管线，XX个设施
- **测试日期**：YYYY-MM-DD

### 测试结果汇总

| 测试用例 | 测试结果 | 备注 |
|---------|---------|------|
| 测试用例1：基本爆管分析流程 | ✅/❌ | |
| 测试用例2：爆管分析边界情况 | ✅/❌ | |
| 测试用例3：爆管分析交互测试 | ✅/❌ | |
| 测试用例4：上游追踪 | ✅/❌ | |
| 测试用例5：下游追踪 | ✅/❌ | |
| 测试用例6：最短路径 | ✅/❌ | |
| 测试用例7：连通性分析边界情况 | ✅/❌ | |
| 测试用例8：功能切换测试 | ✅/❌ | |
| 测试用例9：性能测试 | ✅/❌ | |

### 发现的问题
1. **问题描述**：[描述问题]
   - **严重程度**：高/中/低
   - **复现步骤**：[步骤]
   - **预期结果**：[预期]
   - **实际结果**：[实际]

### 测试结论
- **功能完整性**：✅/❌
- **性能表现**：✅/❌
- **用户体验**：✅/❌
- **总体评价**：[评价]

---

## 九、测试建议

1. **逐步测试**：按照测试用例顺序逐步测试，确保每个功能都经过验证
2. **记录问题**：发现问题时及时记录，包括复现步骤和截图
3. **数据准备**：确保测试数据完整且正确，这是测试成功的基础
4. **边界测试**：特别注意边界情况的测试，这些往往容易出现问题
5. **性能关注**：对于大数据量，关注性能表现
6. **用户体验**：从用户角度测试，确保交互流畅自然

---

**文档版本**：v1.0  
**最后更新**：2024-12-19

