# ğŸ—ºï¸ å¯ç”¨ç®¡ç½‘å¯è§†åŒ–å®Œæ•´æŒ‡å—

**æ—¥æœŸ**: 2024-11-27  
**çŠ¶æ€**: âœ… å·²å¯ç”¨ç®¡ç½‘å¯è§†åŒ–ä»£ç   
**å‰æ**: PostgreSQLç¯å¢ƒæ­£å¸¸

---

## ğŸ“‹ å¿«é€Ÿå¼€å§‹

### æ–¹å¼A: è‡ªåŠ¨æµ‹è¯•ï¼ˆæ¨èï¼‰â­â­â­â­â­

```bash
# 1. æµ‹è¯•æ•°æ®åº“ç¯å¢ƒ
.\scripts\test_database.bat

# 2. å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œå¯åŠ¨ç¨‹åº
.\release\CustomTitleBarApp.exe
```

### æ–¹å¼B: æ‰‹åŠ¨æ­¥éª¤

æŒ‰ç…§ä¸‹é¢çš„è¯¦ç»†æ­¥éª¤é€æ­¥å®Œæˆã€‚

---

## ğŸ” è¯¦ç»†æ­¥éª¤

### æ­¥éª¤1: æ£€æŸ¥PostgreSQLæœåŠ¡

#### Windows

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sc query | findstr postgresql

# æˆ–ä½¿ç”¨æœåŠ¡ç®¡ç†å™¨
services.msc
# æŸ¥æ‰¾ postgresql-x64-16 æˆ–ç±»ä¼¼åç§°

# å¯åŠ¨æœåŠ¡ï¼ˆå¦‚æœæœªè¿è¡Œï¼‰
net start postgresql-x64-16
```

**é¢„æœŸç»“æœ**:
```
SERVICE_NAME: postgresql-x64-16
STATE      : 4  RUNNING
```

---

### æ­¥éª¤2: æ£€æŸ¥æ•°æ®åº“é…ç½®

#### æ£€æŸ¥é…ç½®æ–‡ä»¶

```bash
# æŸ¥çœ‹é…ç½®
type config\database.ini
```

**å…³é”®é…ç½®**:
```ini
[database]
type=postgresql
host=localhost
port=5432
dbname=ugims
username=postgres
password=ä½ çš„å¯†ç   # âš ï¸ ä¿®æ”¹è¿™é‡Œï¼
```

#### ä¿®æ”¹å¯†ç 

```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
notepad config\database.ini

# å°†password=your_passwordæ”¹ä¸ºä½ çš„å®é™…å¯†ç 
password=ä½ çš„PostgreSQLå¯†ç 
```

---

### æ­¥éª¤3: åˆ›å»ºæ•°æ®åº“å’Œå¯¼å…¥æ•°æ®

#### æ–¹å¼A: ä½¿ç”¨æµ‹è¯•è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
.\scripts\test_database.bat
```

**è„šæœ¬ä¼šè‡ªåŠ¨**:
1. âœ… æ£€æŸ¥PostgreSQLæœåŠ¡
2. âœ… æµ‹è¯•æ•°æ®åº“è¿æ¥
3. âœ… åˆ›å»ºugimsæ•°æ®åº“ï¼ˆå¦‚ä¸å­˜åœ¨ï¼‰
4. âœ… å¯ç”¨PostGISæ‰©å±•
5. âœ… å¯¼å…¥æ•°æ®åº“ç»“æ„
6. âœ… å¯¼å…¥æµ‹è¯•æ•°æ®

#### æ–¹å¼B: æ‰‹åŠ¨æ‰§è¡Œ

```bash
# 1. è¿æ¥PostgreSQL
psql -U postgres

# 2. åˆ›å»ºæ•°æ®åº“
CREATE DATABASE ugims ENCODING 'UTF8';

# 3. è¿æ¥åˆ°æ–°æ•°æ®åº“
\c ugims

# 4. å¯ç”¨PostGIS
CREATE EXTENSION IF NOT EXISTS postgis;
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

# 5. é€€å‡ºpsql
\q

# 6. å¯¼å…¥æ•°æ®åº“ç»“æ„
psql -U postgres -d ugims -f database\schema.sql

# 7. å¯¼å…¥æµ‹è¯•æ•°æ®
psql -U postgres -d ugims -f database\test_data.sql

# 8. éªŒè¯æ•°æ®
psql -U postgres -d ugims -c "SELECT COUNT(*) FROM pipelines;"
psql -U postgres -d ugims -c "SELECT COUNT(*) FROM facilities;"
```

**é¢„æœŸè¾“å‡º**:
```
ç®¡çº¿æ•°é‡: 5
è®¾æ–½æ•°é‡: 4
```

---

### æ­¥éª¤4: æµ‹è¯•æ•°æ®åº“è¿æ¥ï¼ˆå¯é€‰ï¼‰

#### ä½¿ç”¨psqlæµ‹è¯•

```bash
# æµ‹è¯•è¿æ¥
psql -U postgres -d ugims -c "SELECT version();"

# æµ‹è¯•PostGIS
psql -U postgres -d ugims -c "SELECT PostGIS_Version();"

# æŸ¥çœ‹æ•°æ®
psql -U postgres -d ugims -c "SELECT pipeline_type, COUNT(*) FROM pipelines GROUP BY pipeline_type;"
```

#### ä½¿ç”¨C++æµ‹è¯•ç¨‹åº

```bash
# ç¼–è¯‘æµ‹è¯•ç¨‹åº
.\scripts\compile_test_db.bat

# è¿è¡Œæµ‹è¯•
.\test_db_connection.exe
```

**é¢„æœŸè¾“å‡º**:
```
========================================
æ•°æ®åº“è¿æ¥æµ‹è¯•
========================================

[1/4] åŠ è½½é…ç½®æ–‡ä»¶...
âœ… app.iniåŠ è½½æˆåŠŸ
âœ… database.iniåŠ è½½æˆåŠŸ

[2/4] åˆå§‹åŒ–æ•°æ®åº“ç®¡ç†å™¨...
âœ… æ•°æ®åº“ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ

[3/4] è¿æ¥æ•°æ®åº“...
æ•°æ®åº“ç±»å‹: postgresql
ä¸»æœº: localhost
ç«¯å£: 5432
æ•°æ®åº“å: ugims
ç”¨æˆ·å: postgres
âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼

[4/4] æµ‹è¯•æ•°æ®æŸ¥è¯¢...

=== ç®¡çº¿ç»Ÿè®¡ ===
ç»™æ°´: 2æ¡
æ’æ°´: 1æ¡
ç‡ƒæ°”: 1æ¡
ç”µåŠ›: 1æ¡

=== è®¾æ–½ç»Ÿè®¡ ===
é˜€é—¨: 2ä¸ª
æ£€æŸ¥äº•: 2ä¸ª

âœ… æ•°æ®æŸ¥è¯¢æˆåŠŸï¼

========================================
æ•°æ®åº“è¿æ¥æµ‹è¯•å®Œæˆ âœ…
========================================
```

---

### æ­¥éª¤5: å¯åŠ¨ç¨‹åº

```bash
# å¯åŠ¨ç¨‹åº
.\release\CustomTitleBarApp.exe

# æˆ–ä½¿ç”¨è¯¦ç»†è¾“å‡º
.\scripts\test_startup_verbose.bat
```

---

## ğŸ“Š ç¨‹åºå¯åŠ¨æµç¨‹

### æ—¶é—´çº¿

```
0ms    - ç¨‹åºå¯åŠ¨
         â”œâ”€ setupUi()
         â””â”€ setupFunctionalArea()
         
100ms  - çª—å£æ˜¾ç¤º âœ…
         â””â”€ setupMapArea() å¼€å§‹
         
500ms  - åœ°å›¾åˆå§‹åŒ–å®Œæˆ âœ…
         
800ms  - ç®¡ç½‘å¯è§†åŒ–åˆå§‹åŒ–å¼€å§‹
         â”œâ”€ Loggeråˆå§‹åŒ–
         â”œâ”€ ConfigåŠ è½½
         â”œâ”€ æ•°æ®åº“é…ç½®åŠ è½½
         â””â”€ æ•°æ®åº“è¿æ¥ (timeout: 5s)
         
3s     - æ•°æ®åº“è¿æ¥å®Œæˆ âœ…
         â”œâ”€ LayerManageråˆ›å»º
         â”œâ”€ SymbolManageråˆå§‹åŒ–
         â”œâ”€ æ¸²æŸ“å™¨åˆ›å»º
         â””â”€ åŠ è½½ç®¡ç½‘æ•°æ®
         
5s     - ç®¡ç½‘æ•°æ®æ¸²æŸ“å®Œæˆ âœ…
```

### å…³é”®æ—¥å¿—

**æˆåŠŸçš„æ—¥å¿—**:
```
[INFO] MyForm constructor finished (UI setup only)
[INFO] Starting async map area initialization
[INFO] TileMapManager created
[INFO] Map area initialization complete
[INFO] Starting async pipeline visualization initialization
[Pipeline] Step 1: Initialize Logger
[Pipeline] âœ… Logger initialized
[Pipeline] Step 2: Load Config
[Pipeline] âœ… App config loaded
[Pipeline] Step 3: Load Database Config
[Pipeline] âœ… Database config loaded
[Pipeline] Step 4: Connect to Database
[Pipeline] Connecting to database (timeout: 5s)...
[Pipeline] âœ… Database connected
[INFO] PostGIS version: 3.4.0
[Pipeline] Step 5: Create LayerManager
[Pipeline] âœ… LayerManager created
[Pipeline] âœ… Initialization complete
```

**å¤±è´¥çš„æ—¥å¿—** (æ•°æ®åº“æœªè¿æ¥):
```
[Pipeline] Step 3: Load Database Config
[Pipeline] âš ï¸  No database config - visualization disabled
[INFO] æ•°æ®åº“é…ç½®æœªæ‰¾åˆ°ï¼ˆåœ°å›¾åŠŸèƒ½æ­£å¸¸ï¼‰
```

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

### æˆåŠŸå¯åŠ¨å

âœ… **çª—å£å¿«é€Ÿæ˜¾ç¤º** (< 0.5ç§’)  
âœ… **è“è‰²æ¸å˜ä¸»é¢˜** æ­£ç¡®åŠ è½½  
âœ… **åœ°å›¾æ­£å¸¸æ˜¾ç¤º** OpenStreetMapç“¦ç‰‡  
âœ… **çŠ¶æ€æ æç¤º** "æ•°æ®åº“å·²è¿æ¥ï¼Œå‡†å¤‡åŠ è½½ç®¡ç½‘æ•°æ®..."  
âœ… **ç®¡çº¿æ˜¾ç¤º** 5-10ç§’ååœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºå½©è‰²ç®¡çº¿  
âœ… **è®¾æ–½æ˜¾ç¤º** é˜€é—¨ã€æ£€æŸ¥äº•ç­‰è®¾æ–½ç‚¹

### åœ°å›¾ä¸Šçš„æ˜¾ç¤º

**ç®¡çº¿é¢œè‰²**:
- ğŸ”µ **è“è‰²** - ç»™æ°´ç®¡çº¿
- ğŸŸ¤ **æ£•è‰²** - æ’æ°´ç®¡çº¿
- ğŸŸ¡ **é‡‘è‰²** - ç‡ƒæ°”ç®¡çº¿
- ğŸ”´ **çº¢è‰²** - ç”µåŠ›ç®¡çº¿
- ğŸŸ¢ **ç»¿è‰²** - é€šä¿¡ç®¡çº¿

**è®¾æ–½å›¾æ ‡**:
- ğŸŸ¢ **ç»¿è‰²åœ†ç‚¹** - é˜€é—¨
- ğŸ”µ **è“è‰²åœ†ç‚¹** - æ£€æŸ¥äº•
- ğŸŸ  **æ©™è‰²åœ†ç‚¹** - å…¶ä»–è®¾æ–½

### æµ‹è¯•æ•°æ®ä½ç½®

é»˜è®¤æµ‹è¯•æ•°æ®ä½äº**åŒ—äº¬å¤©å®‰é—¨é™„è¿‘**:
- ä¸­å¿ƒç‚¹: 39.9042Â°N, 116.4074Â°E
- ç¼©æ”¾ç­‰çº§: 15-17
- èŒƒå›´: çº¦500ç±³åŠå¾„

---

## âš ï¸ æ•…éšœæ’é™¤

### é—®é¢˜1: ç¨‹åºå¡æ­»

**ç—‡çŠ¶**: çª—å£æ˜¾ç¤ºåæ— å“åº”

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥PostgreSQLæœåŠ¡æ˜¯å¦è¿è¡Œ
2. æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦é˜»æ­¢
4. æŸ¥çœ‹æ—¥å¿— `logs\app.log`

```bash
# æŸ¥çœ‹æœ€å50è¡Œæ—¥å¿—
Get-Content logs\app.log -Tail 50
```

---

### é—®é¢˜2: æ•°æ®åº“è¿æ¥è¶…æ—¶

**ç—‡çŠ¶**: 
```
[Pipeline] âŒ DB connect failed: timeout
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥æœåŠ¡
sc query | findstr postgresql

# 2. å¯åŠ¨æœåŠ¡
net start postgresql-x64-16

# 3. æµ‹è¯•è¿æ¥
psql -U postgres -c "SELECT 1"
```

---

### é—®é¢˜3: å¯†ç é”™è¯¯

**ç—‡çŠ¶**:
```
[Pipeline] âŒ DB connect failed: æ•°æ®åº“å¯†ç é”™è¯¯
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. ä¿®æ”¹é…ç½®æ–‡ä»¶
notepad config\database.ini

# 2. æˆ–é‡ç½®PostgreSQLå¯†ç 
psql -U postgres
ALTER USER postgres WITH PASSWORD 'æ–°å¯†ç ';
```

---

### é—®é¢˜4: æ•°æ®åº“ä¸å­˜åœ¨

**ç—‡çŠ¶**:
```
[Pipeline] âŒ DB connect failed: æ•°æ®åº“ä¸å­˜åœ¨
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# è¿è¡Œæ•°æ®åº“æµ‹è¯•è„šæœ¬ï¼Œä¼šè‡ªåŠ¨åˆ›å»º
.\scripts\test_database.bat

# æˆ–æ‰‹åŠ¨åˆ›å»º
createdb -U postgres ugims
psql -U postgres -d ugims -f database\schema.sql
psql -U postgres -d ugims -f database\test_data.sql
```

---

### é—®é¢˜5: åœ°å›¾ä¸Šçœ‹ä¸åˆ°ç®¡ç½‘

**å¯èƒ½åŸå› **:
1. ç¼©æ”¾ç­‰çº§ä¸åˆé€‚ï¼ˆå¤ªè¿œæˆ–å¤ªè¿‘ï¼‰
2. ä¸­å¿ƒç‚¹ä¸åœ¨æ•°æ®èŒƒå›´å†…
3. å›¾å±‚è¢«éšè—
4. æ•°æ®æ¸²æŸ“å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
1. è°ƒæ•´ç¼©æ”¾ç­‰çº§åˆ°15-17
2. ç§»åŠ¨åœ°å›¾åˆ°åŒ—äº¬å¤©å®‰é—¨é™„è¿‘ (116.4074, 39.9042)
3. æ£€æŸ¥æ—¥å¿—ä¸­çš„æ¸²æŸ“é”™è¯¯
4. æŸ¥çœ‹æ•°æ®åº“ä¸­æ˜¯å¦æœ‰æ•°æ®

```sql
-- æ£€æŸ¥æ•°æ®
psql -U postgres -d ugims
SELECT id, pipeline_type, ST_AsText(geometry) FROM pipelines LIMIT 1;
```

---

## ğŸ“ æ£€æŸ¥æ¸…å•

### å¯åŠ¨å‰æ£€æŸ¥

- [ ] PostgreSQLæœåŠ¡è¿è¡Œä¸­
- [ ] config/database.iniå¯†ç æ­£ç¡®
- [ ] ugimsæ•°æ®åº“å·²åˆ›å»º
- [ ] PostGISæ‰©å±•å·²å¯ç”¨
- [ ] æ•°æ®è¡¨å·²å¯¼å…¥
- [ ] æµ‹è¯•æ•°æ®å·²å¯¼å…¥

### å¯åŠ¨åæ£€æŸ¥

- [ ] çª—å£æ­£å¸¸æ˜¾ç¤º
- [ ] åœ°å›¾å¯ä»¥æ‹–æ‹½ç¼©æ”¾
- [ ] çŠ¶æ€æ æ˜¾ç¤º"æ•°æ®åº“å·²è¿æ¥"
- [ ] æ—¥å¿—ä¸­æ— é”™è¯¯
- [ ] åœ°å›¾ä¸Šæ˜¾ç¤ºç®¡çº¿ï¼ˆ5-10ç§’åï¼‰
- [ ] å¯ä»¥ç‚¹å‡»æŸ¥çœ‹ç®¡çº¿å±æ€§

---

## ğŸ”— ç›¸å…³å‘½ä»¤

### PostgreSQLå¸¸ç”¨å‘½ä»¤

```bash
# è¿æ¥æ•°æ®åº“
psql -U postgres -d ugims

# åˆ—å‡ºæ‰€æœ‰æ•°æ®åº“
\l

# åˆ—å‡ºæ‰€æœ‰è¡¨
\dt

# æŸ¥çœ‹è¡¨ç»“æ„
\d pipelines

# é€€å‡º
\q

# ç›´æ¥æ‰§è¡ŒSQL
psql -U postgres -d ugims -c "SELECT COUNT(*) FROM pipelines;"

# å¯¼å‡ºæ•°æ®
pg_dump -U postgres ugims > backup.sql

# å¯¼å…¥æ•°æ®
psql -U postgres -d ugims -f backup.sql
```

---

## ğŸ‰ æˆåŠŸæ ‡å¿—

å½“ä½ çœ‹åˆ°ä»¥ä¸‹å†…å®¹æ—¶ï¼Œè¯´æ˜ä¸€åˆ‡æ­£å¸¸ï¼š

âœ… ç¨‹åºå¿«é€Ÿå¯åŠ¨  
âœ… åœ°å›¾æ­£å¸¸æ˜¾ç¤º  
âœ… çŠ¶æ€æ : "æ•°æ®åº“å·²è¿æ¥ï¼Œå‡†å¤‡åŠ è½½ç®¡ç½‘æ•°æ®..."  
âœ… æ—¥å¿—: `[Pipeline] âœ… Database connected`  
âœ… æ—¥å¿—: `[INFO] PostGIS version: 3.x.x`  
âœ… åœ°å›¾ä¸Šå‡ºç°å½©è‰²ç®¡çº¿  
âœ… å¯ä»¥ç¼©æ”¾å’Œæ‹–æ‹½  

**æ­å–œï¼ç®¡ç½‘å¯è§†åŒ–åŠŸèƒ½å·²æˆåŠŸå¯ç”¨ï¼** ğŸ‰ğŸ—ºï¸

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [DATABASE_SETUP.md](DATABASE_SETUP.md) - è¯¦ç»†æ•°æ®åº“è®¾ç½®
- [SPATIAL_ANALYSIS_MODULE.md](SPATIAL_ANALYSIS_MODULE.md) - ç©ºé—´åˆ†æåŠŸèƒ½
- [PROJECT_STRUCTURE.md](PROJECT_STRUCTURE.md) - é¡¹ç›®ç»“æ„
- [å¯åŠ¨å¡æ­»ä¿®å¤.md](å¯åŠ¨å¡æ­»ä¿®å¤.md) - å¯åŠ¨é—®é¢˜æ’æŸ¥

---

**å‡†å¤‡å¥½æµ‹è¯•äº†å—ï¼Ÿè¿è¡Œ `.\scripts\test_database.bat` å¼€å§‹ï¼** ğŸš€

