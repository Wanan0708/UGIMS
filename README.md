# UGIMS - 城市地下管网智能管理系统

<div align="center">

![Qt](https://img.shields.io/badge/Qt-5%2F6-41CD52?logo=qt)
![C++](https://img.shields.io/badge/C++-17-00599C?logo=cplusplus)
![GIS](https://img.shields.io/badge/GIS-Enabled-green)
![License](https://img.shields.io/badge/license-MIT-blue)

**Underground Utility Information Management System**

一个基于 Qt/C++ 的城市地下管网智能管理与分析系统

</div>

## 📖 项目简介

UGIMS (Underground Utility Information Management System - 城市地下管网智能管理系统) 是一个专业的地下管网可视化管理平台，集成了 GIS 地图展示、管网设施管理、空间分析、巡检工单管理等功能模块，为城市基础设施管理部门提供完整的数字化解决方案。

### 🎯 应用场景

- 🏙️ **市政管网管理**: 水务、燃气、供电、通信等部门的管网资产管理
- 🔧 **运维调度**: 巡检任务管理、故障报修、应急响应
- 📊 **规划决策**: 管网现状分析、改扩建规划、投资决策支持
- 🚨 **应急管理**: 爆管影响分析、应急预案制定、快速定位抢修
- 📱 **移动巡检**: 支持离线地图，现场巡检数据采集

## ✨ 核心功能

### 1. 🗺️ 管网可视化展示

#### 多类型管线支持
- ✅ **给水管网**: 供水主干管、支线管、消火栓等设施
- ✅ **排水管网**: 污水管、雨水管、合流管及泵站
- ✅ **燃气管网**: 高压、中压、低压燃气管线及调压站
- ✅ **供电管网**: 电力电缆、变压器、配电箱等设施
- ✅ **通信管网**: 通信光缆、管道井、接线盒等
- ✅ **供热管网**: 热力管线、换热站等

#### 可视化特性
```
多层级展示:
├── 基础地图层 (OpenStreetMap/离线瓦片)
├── 管线图层 (按类型分层显示)
│   ├── 颜色编码 (水-蓝色、气-黄色、电-红色、通信-绿色)
│   ├── 管径粗细 (DN100-DN1200 视觉差异化)
│   └── 材质标识 (钢管、铸铁、PE、PVC 等)
├── 设施图层 (阀门、井盖、泵站等)
└── 标注图层 (管线编号、设施名称)
```

#### 交互功能
- 🖱️ 地图拖拽、缩放 (3-18级)
- 🔍 图层控制 (显示/隐藏特定管线类型)
- 📍 点击查询管线/设施属性
- 📐 测距测面工具
- 🎨 专题渲染 (按建设年代、管径、材质等着色)

### 2. 🔍 空间查询与智能分析

#### 基础查询
- **属性查询**: 按管线编号、材质、管径、建设年代等条件查询
- **空间查询**: 
  - 点击选择: 地图上直接点击管线/设施
  - 框选查询: 矩形/圆形/多边形范围查询
  - 缓冲区查询: 指定点/线周边一定距离内的管线
- **统计查询**: 管线总长度、设施数量、管材分布等统计

#### 智能分析功能

##### 🚰 爆管影响分析
```
分析流程:
1. 选择爆管点位置
2. 系统自动追踪连通管线
3. 识别需关闭的阀门位置
4. 计算受影响用户范围
5. 生成停水影响报告
```

**输出结果**:
- 📍 建议关闭的阀门位置列表
- 👥 影响用户数量和范围
- 📊 停水区域可视化
- ⏱️ 预计抢修时间和影响时长

##### 🔗 连通性分析
```
应用场景:
- 给水管网: 从水厂到用户的供水路径分析
- 燃气管网: 气源到用户的供气路径追踪
- 排水管网: 污水排放路径及汇水分析
```

**分析类型**:
- **上游追踪**: 追溯管线来源 (如追溯到水厂)
- **下游追踪**: 追踪管线去向 (如追踪到污水处理厂)
- **连通性检查**: 检查管网是否形成环网、是否存在断点
- **最优路径**: 计算两点间的最优管线路径

##### 📈 管网健康度评估
- **老化分析**: 基于建设年限、材质、历史故障率评估
- **风险等级**: 高风险管段识别和预警
- **改造优先级**: 基于健康度和重要性的改造排序

##### 🌊 水力分析 (扩展功能)
- 压力分布计算
- 流量分配模拟
- 水质追踪模拟

### 3. 📋 巡检工单管理

#### 工单类型
- 🔍 **日常巡检**: 定期巡检任务
- 🔧 **维修工单**: 故障报修处理
- ⚠️ **应急工单**: 突发事件响应
- 🔄 **改造工单**: 改扩建项目管理

#### 工单全生命周期管理
```
工单流程:
创建 → 派发 → 接收 → 执行 → 完成 → 审核 → 归档
```

**功能特性**:
- ✅ 工单创建与派发 (支持批量派发)
- ✅ 任务分配与提醒 (邮件/短信通知)
- ✅ 移动端现场记录 (拍照、定位、备注)
- ✅ 进度跟踪与监控 (实时查看工单状态)
- ✅ 完成情况统计 (按人员/时间/类型统计)
- ✅ 历史记录查询 (工单档案检索)

#### 工单数据结构
```json
{
  "workOrderId": "WO20250126001",
  "type": "维修工单",
  "priority": "紧急",
  "status": "执行中",
  "assetInfo": {
    "assetId": "VALVE-001",
    "assetType": "阀门",
    "location": {"lat": 39.9042, "lon": 116.4074}
  },
  "description": "阀门漏水，需要更换",
  "assignedTo": "张工",
  "createdAt": "2025-01-26 08:30:00",
  "deadline": "2025-01-26 18:00:00",
  "photos": ["photo1.jpg", "photo2.jpg"],
  "remarks": "已更换DN200闸阀，试压正常"
}
```

### 4. 🏗️ 资产台账管理

#### 资产分类
```
管线资产:
├── 给水管线
├── 排水管线
├── 燃气管线
├── 电力电缆
├── 通信线缆
└── 供热管线

设施资产:
├── 阀门 (闸阀、蝶阀、止回阀等)
├── 井盖 (检查井、阀门井等)
├── 泵站 (给水泵站、排水泵站)
├── 调压站 (燃气调压装置)
├── 变压器 (电力设施)
└── 接线盒 (通信设施)
```

#### 资产属性管理

**管线属性**:
```
基础信息: 编号、名称、类型、起终点
几何信息: 坐标串、长度、埋深
物理属性: 管径、材质、压力等级
建设信息: 建设时间、建设单位、造价
运维信息: 养护单位、巡检周期、维修记录
```

**设施属性**:
```
基础信息: 编号、名称、类型、坐标
物理属性: 规格型号、材质、尺寸
状态信息: 运行状态、健康度评分
维护信息: 上次维护时间、维护人员、备件信息
```

#### 资产管理功能
- ✅ 资产登记与录入 (批量导入/单个添加)
- ✅ 属性编辑与更新 (字段级权限控制)
- ✅ 资产档案管理 (关联照片、文档、竣工图)
- ✅ 变更历史追踪 (谁在何时修改了什么)
- ✅ 报表统计导出 (Excel/PDF/Word 格式)
- ✅ 资产二维码管理 (扫码查看资产信息)
- ✅ 折旧计算与评估 (资产价值管理)

### 5. 🌐 离线/在线地图操作

#### 在线模式
```
特性:
✅ 实时加载最新地图数据
✅ 支持多种瓦片源 (OSM, Google, 天地图等)
✅ 智能缓存机制 (自动缓存浏览过的区域)
✅ 按需下载 (只下载可视区域瓦片)
```

#### 离线模式
```
应用场景:
- 现场巡检 (地下室、偏远地区无网络)
- 应急抢险 (网络中断情况)
- 移动办公 (节省流量)
- 数据安全 (涉密区域禁止联网)
```

**离线功能**:
- ✅ 区域地图预下载 (按经纬度范围和缩放层级)
- ✅ 本地瓦片缓存 (34,000+ 已缓存瓦片可直接使用)
- ✅ 离线矢量数据 (管线、设施数据本地存储)
- ✅ 自动切换模式 (检测网络状态自动切换)
- ✅ 增量同步 (联网后自动同步变更数据)

#### 地图下载管理器
```
配置项:
- 下载区域: 通过经纬度或地图框选定义
- 缩放层级: 选择需要的缩放级别 (3-18)
- 下载策略:
  ├── 并发控制: 4-8 线程并发
  ├── 速率限制: 10-20 瓦片/秒
  ├── 失败重试: 3次重试机制
  └── 断点续传: 支持暂停和恢复
```

**下载进度管理**:
- 实时进度显示 (已下载/总数)
- 任务队列管理 (多任务并行)
- 错误日志记录 (失败瓦片列表)
- 存储空间提示 (预估所需空间)

## 🖼️ 系统界面

### 主界面布局
```
┌─────────────────────────────────────────────────────────────────┐
│  🟠 UGIMS - 城市地下管网智能管理系统           ─  □  ✕         │
├─────────────────────────────────────────────────────────────────┤
│  文件  管网  分析  工单  资产  下载  设置  帮助                  │
├──────────┬──────────────────────────────────────────────────────┤
│          │                                                       │
│  图层树  │              地图展示区域                             │
│ ────────│      ┌─────────────────────────┐                     │
│ □ 给水   │      │   管网可视化 + 交互     │         🔍          │
│   ├─管线 │      │   ● 点击查询属性        │         ➕ ➖      │
│   └─阀门 │      │   ● 框选空间查询        │         📏 📐      │
│ □ 排水   │      │   ● 右键菜单操作        │                     │
│ □ 燃气   │      └─────────────────────────┘                     │
│ □ 电力   │                                                       │
│ □ 通信   │   [分析工具栏]  [工单面板]  [资产列表]               │
│          │                                                       │
│  工具箱  │   状态栏: 坐标 | 比例尺 | 在线/离线 | 数据统计       │
└──────────┴──────────────────────────────────────────────────────┘
```

### 功能模块界面

#### 管网分析界面
```
爆管分析对话框:
┌─────────────────────────────┐
│  爆管影响分析                 │
├─────────────────────────────┤
│  爆管点: [在地图上选择]       │
│  管线类型: [给水管] ▼        │
│  管径: DN200                 │
│  分析半径: [500] 米          │
│                              │
│  [开始分析]  [重置]  [导出]  │
├─────────────────────────────┤
│  分析结果:                    │
│  □ 需关闭阀门: 5个           │
│  □ 影响用户: 约2300户        │
│  □ 停水范围: 3.2平方公里     │
│  □ 建议处理时间: 4-6小时     │
└─────────────────────────────┘
```

#### 工单管理界面
```
工单列表:
┌──────────────────────────────────────────────────────┐
│  工单管理  [新建] [导出] [刷新]                        │
├────────┬────────┬──────┬──────┬──────┬──────────────┤
│ 工单号  │ 类型   │ 优先级│ 状态 │ 负责人│ 创建时间     │
├────────┼────────┼──────┼──────┼──────┼──────────────┤
│ WO001  │ 维修   │ 紧急 │ 执行中│ 张工 │ 2025-01-26   │
│ WO002  │ 巡检   │ 普通 │ 待派发│ 待定 │ 2025-01-26   │
│ WO003  │ 改造   │ 重要 │ 已完成│ 李工 │ 2025-01-25   │
└────────┴────────┴──────┴──────┴──────┴──────────────┘
   [详情] [派发] [跟踪] [完成] [导出工单报告]
```

## 🛠️ 技术架构

### 技术栈
| 层次 | 技术 | 说明 |
|------|------|------|
| **UI层** | Qt Widgets | 跨平台桌面应用界面 |
| **GIS引擎** | QGraphicsView | 地图渲染和交互 |
| **空间分析** | 自研算法 | 连通性、缓冲区等空间算法 |
| **网络层** | QNetworkAccessManager | HTTP瓦片下载 |
| **数据存储** | SQLite / PostgreSQL + PostGIS | 本地/远程数据库 |
| **数据格式** | JSON / Shapefile / GeoJSON | 管网数据交换格式 |
| **开发语言** | C++17 | 高性能业务逻辑 |

### 系统架构图
```
┌─────────────────────────────────────────────────────┐
│                  表示层 (Qt Widgets)                 │
│  ┌──────────┬──────────┬──────────┬──────────────┐ │
│  │地图展示  │工单管理  │资产管理  │分析工具      │ │
│  └──────────┴──────────┴──────────┴──────────────┘ │
├─────────────────────────────────────────────────────┤
│                  业务逻辑层 (C++)                    │
│  ┌──────────┬──────────┬──────────┬──────────────┐ │
│  │管网可视化│空间分析  │工单调度  │资产管理      │ │
│  │TileMapMgr│Analyzer  │Scheduler │AssetManager  │ │
│  └──────────┴──────────┴──────────┴──────────────┘ │
├─────────────────────────────────────────────────────┤
│                  数据访问层 (DAO)                    │
│  ┌──────────┬──────────┬──────────┬──────────────┐ │
│  │瓦片缓存  │矢量数据  │工单数据  │资产数据      │ │
│  │TileCache │VectorDAO │OrderDAO  │AssetDAO      │ │
│  └──────────┴──────────┴──────────┴──────────────┘ │
├─────────────────────────────────────────────────────┤
│                  数据存储层                          │
│  ┌──────────┬──────────┬──────────┬──────────────┐ │
│  │瓦片文件  │SQLite DB │PostGIS   │文件系统      │ │
│  │tilemap/  │local.db  │Remote    │档案资料      │ │
│  └──────────┴──────────┴──────────┴──────────────┘ │
└─────────────────────────────────────────────────────┘
```

### 核心模块说明

#### TileMapManager (地图管理器)
- **职责**: 底图加载、显示、缓存
- **特性**: 支持在线/离线切换、瓦片预下载

#### PipelineRenderer (管网渲染器)
- **职责**: 管线矢量数据渲染
- **特性**: 分层显示、符号化、标注

#### SpatialAnalyzer (空间分析引擎)
- **职责**: 爆管分析、连通性分析、缓冲区等
- **算法**: 图论算法、拓扑分析、空间计算

#### WorkOrderManager (工单管理器)
- **职责**: 工单CRUD、状态流转、派发调度
- **特性**: 生命周期管理、消息通知

#### AssetManager (资产管理器)
- **职责**: 资产台账管理、属性维护
- **特性**: 版本控制、变更追踪

#### DataSync (数据同步模块)
- **职责**: 本地与服务器数据同步
- **特性**: 增量同步、冲突解决

## 📋 系统要求

### 开发环境
- Qt 5.15+ 或 Qt 6.2+
- C++17 兼容编译器
  - Windows: MSVC 2019+ / MinGW 8.1+
  - Linux: GCC 8+ / Clang 7+
  - macOS: Xcode 11+
- 可选: PostgreSQL 12+ (如使用远程数据库)

### 运行环境
- **操作系统**: Windows 10/11, Linux, macOS 10.15+
- **内存**: 至少 2GB 可用内存 (推荐 4GB+)
- **磁盘**: 
  - 系统程序: ~200MB
  - 离线地图缓存: 1-10GB (根据下载区域)
  - 数据库: 100MB-5GB (根据管网规模)
- **显示器**: 分辨率 1920x1080 或更高
- **网络**: 用于在线地图和数据同步 (离线模式不需要)

## 🚀 快速开始

### 1. 克隆项目

```bash
git clone <repository-url>
cd UGIMS
```

> 💡 **提示**: 本项目包含预下载的地图瓦片缓存（`tilemap/` 目录），克隆后可直接使用已有地图数据，无需重新下载。

### 2. 配置数据库 (可选)

#### 使用 SQLite (默认，无需配置)
项目默认使用 SQLite 本地数据库，自动创建在 `data/ugims.db`

#### 使用 PostgreSQL + PostGIS (生产环境推荐)

```bash
# 1. 安装 PostgreSQL 和 PostGIS 扩展
sudo apt install postgresql postgis  # Linux
# 或使用其他方式安装

# 2. 创建数据库
psql -U postgres
CREATE DATABASE ugims;
\c ugims
CREATE EXTENSION postgis;

# 3. 导入数据库架构
psql -U postgres -d ugims -f database/schema.sql

# 4. 配置连接信息
编辑 config/database.ini:
[database]
type=postgresql
host=localhost
port=5432
dbname=ugims
username=postgres
password=your_password
```

### 3. 编译项目

#### 使用 Qt Creator
1. 打开 `CustomTitleBarApp.pro`
2. 配置 Qt Kit
3. 点击 "构建" 按钮

#### 使用命令行 (qmake)

```bash
# Windows
qmake CustomTitleBarApp.pro
nmake        # 或 mingw32-make

# Linux / macOS
qmake CustomTitleBarApp.pro
make -j4
```

### 4. 运行程序

```bash
# Windows
.\release\CustomTitleBarApp.exe

# Linux / macOS
./CustomTitleBarApp
```

### 5. 初始化数据

#### 导入管网数据

系统支持以下格式的管网数据导入：

1. **Shapefile** (.shp)
   ```
   菜单: 数据 → 导入 → Shapefile
   选择管线/设施 shapefile 文件
   映射字段到系统属性
   ```

2. **GeoJSON** (.json, .geojson)
   ```
   菜单: 数据 → 导入 → GeoJSON
   支持标准 GeoJSON 格式
   ```

3. **Excel** (.xlsx) - 设施点数据
   ```
   菜单: 资产 → 批量导入
   使用提供的 Excel 模板
   包含经纬度坐标信息
   ```

4. **CAD图纸** (.dwg, .dxf)
   ```
   菜单: 数据 → CAD转换
   需要配置坐标系
   自动提取管线要素
   ```

## 📚 使用指南

### 基础操作

#### 地图导航
- **拖拽**: 鼠标左键或右键拖拽地图
- **缩放**: 鼠标滚轮或右上角 ➕ ➖ 按钮
- **双击**: 双击放大地图
- **Shift+框选**: 放大到选中区域
- **快捷键**:
  - `+/-`: 放大/缩小
  - `方向键`: 平移地图
  - `Home`: 返回初始视图
  - `F11`: 全屏模式

#### 图层控制
1. 左侧图层树勾选/取消显示图层
2. 右键图层 → 属性 → 调整透明度、颜色
3. 拖拽图层调整显示顺序

#### 管线查询
1. **点击查询**: 直接点击管线/设施查看属性
2. **属性查询**: 工具栏 → 查询 → 按属性查询
3. **空间查询**: 工具栏 → 查询 → 框选/缓冲区查询

### 进阶功能

#### 爆管影响分析

**使用步骤**:

1. **选择分析工具**
   ```
   菜单: 分析 → 爆管影响分析
   ```

2. **指定爆管点**
   - 在地图上点击选择爆管位置
   - 或输入管线编号

3. **设置分析参数**
   ```
   管线类型: [给水管/燃气管等]
   分析半径: [500米]
   考虑因素: ☑ 阀门位置 ☑ 用户分布 ☑ 重要设施
   ```

4. **执行分析**
   - 点击"开始分析"
   - 系统自动计算影响范围
   - 生成分析报告

5. **查看结果**
   ```
   可视化展示:
   - 受影响管段 (红色高亮)
   - 建议关闭阀门 (黄色标注)
   - 影响区域 (半透明填充)
   
   统计信息:
   - 需关闭阀门数量和位置
   - 影响用户数量
   - 停水范围面积
   - 预计抢修时间
   ```

6. **导出报告**
   - PDF格式应急预案
   - Word格式详细报告
   - Excel格式数据清单

#### 连通性分析

**应用场景示例**:

**场景1: 供水路径追踪**
```
问题: 某小区水压不足，需追溯供水来源

操作:
1. 分析 → 连通性分析 → 上游追踪
2. 在地图上选择该小区进水点
3. 系统自动追踪到水厂
4. 高亮显示完整供水路径
5. 检查路径上的阀门状态、管径变化
```

**场景2: 环网检查**
```
问题: 检查给水管网是否形成环网

操作:
1. 分析 → 连通性分析 → 环网检测
2. 选择分析区域
3. 系统识别环网和枝状网
4. 标注断点和单向供水区域
```

**场景3: 污水排放路径**
```
问题: 新建小区污水排放路径规划

操作:
1. 分析 → 连通性分析 → 下游追踪
2. 在地图上标注小区位置
3. 系统追踪到最近污水处理厂
4. 计算排放路径和必经泵站
```

#### 工单管理流程

**创建巡检工单**:

1. **新建工单**
   ```
   工单 → 新建 → 选择类型: 日常巡检
   ```

2. **填写信息**
   ```
   工单信息:
   - 标题: 2025年1月管网例行巡检
   - 优先级: 普通
   - 负责人: [选择巡检人员]
   - 计划时间: 2025-01-27 08:00
   - 巡检区域: [在地图上框选区域]
   ```

3. **选择巡检对象**
   ```
   自动加载区域内所有设施:
   ☑ 阀门 (15个)
   ☑ 井盖 (23个)
   ☑ 消火栓 (8个)
   
   或手动添加特定设施
   ```

4. **设置巡检项**
   ```
   巡检内容:
   ☑ 设施完好性检查
   ☑ 周边环境检查
   ☑ 拍照记录
   ☑ 坐标校核
   ```

5. **派发工单**
   - 短信/邮件通知
   - 移动端APP接收

**现场执行**:

```
移动端操作:
1. 打开工单 → 开始巡检
2. 导航到第一个点位
3. 到达后自动定位签到
4. 填写巡检表单
5. 拍照上传 (支持离线缓存)
6. 提交数据 (离线模式下本地保存)
7. 自动导航到下一个点位
8. 完成所有点位后提交工单
```

**工单审核**:

```
PC端操作:
1. 工单 → 待审核列表
2. 查看工单详情和现场照片
3. 在地图上查看轨迹和签到点
4. 审核通过/退回修改
5. 生成巡检报告归档
```

#### 资产管理操作

**资产登记**:

1. **单个添加**
   ```
   资产 → 新增 → 选择类型
   
   示例: 添加阀门
   - 基础信息: 编号、名称、类型
   - 位置: 在地图上点击或输入坐标
   - 属性: 管径DN200、闸阀、铸铁
   - 建设信息: 2020-05-15、XX建设公司
   - 上传照片: 阀门外观照片
   ```

2. **批量导入**
   ```
   资产 → 批量导入 → 下载Excel模板
   
   模板格式:
   编号 | 名称 | 类型 | 经度 | 纬度 | 管径 | 材质 | ...
   V001 | 1#阀| 闸阀| 116.40| 39.90| DN200| 铸铁| ...
   
   填写完成后导入系统
   ```

**资产查询与编辑**:

1. **快速查找**
   ```
   工具栏搜索框: 输入资产编号/名称
   回车 → 地图定位并高亮显示
   ```

2. **高级查询**
   ```
   资产 → 高级查询
   
   条件组合:
   - 资产类型: 阀门
   - 建设年代: 1990-2000
   - 健康度: < 60分
   - 区域: [框选区域]
   
   查询结果: 显示列表并在地图标注
   ```

3. **批量编辑**
   ```
   选中多个资产 → 右键 → 批量编辑
   可批量修改: 养护单位、巡检周期等
   ```

**资产分析与报表**:

```
资产 → 统计分析

报表类型:
1. 资产汇总表 (按类型/材质/年代统计)
2. 老化资产清单 (超过设计年限)
3. 维修频次排名 (高频故障设施)
4. 资产价值评估 (考虑折旧)
5. 改造计划建议 (基于风险评估)

导出格式: Excel / PDF / Word
```

### 离线地图使用

#### 下载离线地图

1. **打开下载管理器**
   ```
   菜单: 下载 → 地图下载管理
   ```

2. **配置下载参数**
   ```
   下载配置:
   
   瓦片源:
   - OpenStreetMap (推荐)
   - 天地图 (需API Key)
   - 自定义URL
   
   下载区域:
   方式1: 输入经纬度
   - 最小经度: 116.0
   - 最大经度: 116.8
   - 最小纬度: 39.5
   - 最大纬度: 40.2
   
   方式2: 地图框选 (点击"在地图上选择"按钮)
   
   缩放层级:
   - 最小层级: 10 (区域概览)
   - 最大层级: 18 (街道细节)
   ⚠️ 层级越高，瓦片数量越多
   
   下载控制:
   - 并发数: 6 (推荐4-8)
   - 速率限制: 15瓦片/秒
   - 失败重试: 3次
   ```

3. **预览下载量**
   ```
   系统自动计算:
   - 瓦片数量: 约 15,320 个
   - 预计大小: 约 380 MB
   - 预计时间: 约 17 分钟
   ```

4. **开始下载**
   ```
   点击"开始下载"
   - 实时显示进度
   - 可暂停/恢复
   - 支持断点续传
   ```

#### 使用离线地图

**自动模式**:
```
系统自动检测网络状态:
- 有网络: 优先使用缓存，未缓存则在线加载
- 无网络: 自动切换离线模式，只使用本地缓存
```

**手动切换**:
```
状态栏 → 点击"在线"/"离线"指示器
或使用快捷键: Ctrl+M
```

**离线模式限制**:
- ✅ 地图浏览、缩放、平移 (正常)
- ✅ 管网数据查询、分析 (正常)
- ✅ 工单创建和离线记录 (正常)
- ⚠️ 超出缓存范围显示空白
- ⚠️ 数据同步需联网后执行

## 🔧 配置说明

### 系统配置文件

配置文件位置: `config/settings.ini`

```ini
[General]
language=zh_CN
theme=light
autosave=true

[Database]
type=sqlite
path=data/ugims.db
# 如使用PostgreSQL，修改以下配置
# type=postgresql
# host=localhost
# port=5432
# database=ugims
# username=postgres
# password=your_password

[Map]
defaultCenter=116.4074,39.9042
defaultZoom=12
tileSource=https://tile.openstreetmap.org/{z}/{x}/{y}.png
cacheDir=tilemap
maxCacheSize=5000
offlineMode=auto

[Network]
maxConcurrent=6
rateLimitPerSec=15
timeout=30
retries=3

[Pipeline]
defaultLineWidth=3
colorScheme=standard
# 管线颜色配置
colorWater=#0000FF
colorGas=#FFFF00
colorElectric=#FF0000
colorTelecom=#00FF00
colorHeat=#FF8C00

[Analysis]
bufferRadius=500
maxTraceDepth=100
```

### 管线符号配置

配置文件: `config/symbols.json`

```json
{
  "pipelines": {
    "water_supply": {
      "color": "#0066CC",
      "width": "diameter/50",
      "style": "solid",
      "label": "管径+材质"
    },
    "sewage": {
      "color": "#8B4513",
      "width": "diameter/50",
      "style": "solid",
      "arrow": true
    },
    "gas": {
      "color": "#FFD700",
      "width": "diameter/50",
      "style": "dashed",
      "labelBg": "#FFFF00"
    }
  },
  "facilities": {
    "valve": {
      "icon": "icons/valve.png",
      "size": 16,
      "anchor": "center"
    },
    "manhole": {
      "icon": "icons/manhole.png",
      "size": 12,
      "anchor": "center"
    }
  }
}
```

## 📦 数据格式

### 管线数据格式 (GeoJSON)

```json
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "LineString",
        "coordinates": [
          [116.4074, 39.9042],
          [116.4084, 39.9052],
          [116.4094, 39.9062]
        ]
      },
      "properties": {
        "pipelineId": "WL-2023-001",
        "pipelineName": "XX路给水主干管",
        "type": "water_supply",
        "diameter": 400,
        "material": "ductile_iron",
        "pressure": "0.35MPa",
        "depth": 1.5,
        "buildDate": "2023-05-15",
        "builder": "XX建设公司",
        "owner": "XX水务局",
        "status": "active",
        "healthScore": 85,
        "remarks": "状态良好"
      }
    }
  ]
}
```

### 设施数据格式 (GeoJSON)

```json
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [116.4074, 39.9042]
      },
      "properties": {
        "facilityId": "VALVE-2023-001",
        "facilityName": "1#阀门井",
        "type": "gate_valve",
        "spec": "DN400",
        "material": "ductile_iron",
        "buildDate": "2023-05-15",
        "status": "normal",
        "lastInspection": "2025-01-15",
        "healthScore": 90,
        "qrCode": "https://example.com/qr/VALVE-2023-001",
        "photos": [
          "photos/valve001_1.jpg",
          "photos/valve001_2.jpg"
        ]
      }
    }
  ]
}
```

## 🐛 常见问题

### Q1: 管网数据不显示
**A**: 检查以下几点：
1. 确认数据已正确导入 (资产 → 资产统计)
2. 检查图层是否勾选显示 (左侧图层树)
3. 缩放到合适层级 (某些图层有显示层级限制)
4. 检查数据坐标系是否正确 (应为 WGS84 经纬度)

### Q2: 离线地图显示不完整
**A**: 可能的原因：
1. 缓存范围不够 → 下载更大范围或更多层级
2. 当前缩放层级未下载 → 下载对应层级瓦片
3. 瓦片文件损坏 → 重新下载该区域
4. 检查 `tilemap/` 目录下是否有对应 z/x/y.png 文件

### Q3: 爆管分析结果不准确
**A**: 优化建议：
1. 确保管网数据连通性正确 (管线端点对齐)
2. 阀门数据完整且位置准确
3. 检查分析参数设置 (半径、管线类型)
4. 运行"数据质量检查"工具修复拓扑问题

### Q4: 工单照片无法上传
**A**: 排查步骤：
1. 检查网络连接 (离线模式下照片会缓存到本地)
2. 检查照片大小 (单张不超过 10MB)
3. 检查存储空间 (确保有足够磁盘空间)
4. 联网后执行"同步离线数据"

### Q5: 系统运行卡顿
**A**: 性能优化：
1. 减少同时显示的管线数量 (关闭部分图层)
2. 降低地图缩放层级 (显示更大范围)
3. 清理过期缓存 (工具 → 清理缓存)
4. 升级硬件 (增加内存或使用 SSD)
5. 启用硬件加速 (设置 → 显示 → 启用 OpenGL)

### Q6: 导入 CAD 图纸失败
**A**: 注意事项：
1. 确保 CAD 版本支持 (推荐 AutoCAD 2010-2024)
2. 设置正确的坐标系 (与实际坐标系一致)
3. 检查 CAD 图层命名 (按约定命名管线图层)
4. 处理复杂图形 (简化多义线、分解图块)
5. 参考"CAD数据导入指南"文档

## 📝 开发计划

### 第一阶段: 基础平台 ✅
- [x] 地图引擎集成
- [x] 离线/在线地图支持
- [x] 基础UI框架
- [x] 数据库设计

### 第二阶段: 核心功能 🚧 (当前阶段)
- [x] 管网可视化展示
- [ ] 爆管影响分析 (算法开发中)
- [ ] 连通性分析 (算法开发中)
- [ ] 工单管理模块 (UI完成，业务逻辑开发中)
- [ ] 资产台账管理 (数据结构完成，功能开发中)

### 第三阶段: 高级分析 📅
- [ ] 水力模拟 (基于 EPANET 引擎)
- [ ] 管网健康度评估模型
- [ ] 改造优先级算法
- [ ] AI 异常检测 (基于历史数据)
- [ ] 预测性维护 (故障预测)

### 第四阶段: 移动端 📅
- [ ] Android APP (巡检、报修)
- [ ] iOS APP
- [ ] 移动端离线数据包
- [ ] 实时数据同步
- [ ] 语音录入和识别

### 第五阶段: 集成与扩展 📅
- [ ] BIM模型集成 (3D可视化)
- [ ] IoT设备接入 (压力监测、流量计)
- [ ] 视频监控集成
- [ ] GIS服务发布 (WMS/WFS)
- [ ] 大屏展示系统
- [ ] 数据大屏可视化

## 🤝 贡献指南

欢迎参与 UGIMS 项目开发！

### 贡献方式

1. **报告问题**: 在 Issues 中提交 Bug 或建议
2. **提交代码**: Fork 项目并提交 Pull Request
3. **完善文档**: 改进使用手册和API文档
4. **分享经验**: 在 Discussions 分享使用经验

### 开发流程

1. Fork 本仓库
2. 创建特性分支
   ```bash
   git checkout -b feature/pipeline-health-analysis
   ```
3. 提交更改
   ```bash
   git commit -m "Add pipeline health analysis module"
   ```
4. 推送到分支
   ```bash
   git push origin feature/pipeline-health-analysis
   ```
5. 开启 Pull Request

### 代码规范

- 遵循 Qt 编码风格
- 使用有意义的变量和函数名
- 添加必要的注释（复杂算法必须注释）
- 单元测试覆盖率 > 70%
- 提交前运行代码检查工具

### 分支管理

```
main (主分支，稳定版本)
  ├── develop (开发分支)
  │   ├── feature/xxx (功能分支)
  │   ├── bugfix/xxx (Bug修复)
  │   └── hotfix/xxx (紧急修复)
  └── release/x.x.x (发布分支)
```

### 提交信息规范

```
<type>(<scope>): <subject>

type: feat | fix | docs | style | refactor | test | chore
scope: pipeline | analysis | workorder | asset | map | ui
subject: 简短描述 (不超过50字)

示例:
feat(analysis): Add burst pipe impact analysis algorithm
fix(map): Fix offline tile loading issue
docs(readme): Update installation guide
```

## 📄 许可证

本项目采用 **MIT 许可证** - 详见 [LICENSE](LICENSE) 文件

您可以自由地：
- ✅ 商业使用
- ✅ 修改源代码
- ✅ 分发
- ✅ 私人使用

条件：
- ⚠️ 保留版权和许可声明
- ⚠️ 作者不承担任何责任

## 📧 联系方式

- **项目主页**: [GitHub Repository](https://github.com/yourusername/UGIMS)
- **问题反馈**: [Issue Tracker](https://github.com/yourusername/UGIMS/issues)
- **技术讨论**: [Discussions](https://github.com/yourusername/UGIMS/discussions)
- **邮件联系**: ugims@example.com
- **QQ交流群**: 123456789

## 🙏 致谢

### 开源项目
- [Qt Framework](https://www.qt.io/) - 强大的跨平台应用框架
- [OpenStreetMap](https://www.openstreetmap.org/) - 免费的地图数据
- [GDAL](https://gdal.org/) - 地理空间数据抽象库
- [Boost.Geometry](https://www.boost.org/doc/libs/geometry/) - 空间几何算法库

### 技术支持
感谢以下组织和个人对项目的支持：
- XX市水务局 - 提供测试数据和应用场景
- XX大学GIS实验室 - 算法技术支持
- 所有贡献者和使用者 - 感谢你们的反馈和建议

## 📚 相关资源

### 文档
- [详细用户手册](docs/user_manual.pdf)
- [开发者文档](docs/developer_guide.md)
- [API参考](docs/api_reference.md)
- [数据标准](docs/data_standard.md)

### 视频教程
- [系统安装配置](https://example.com/video/install)
- [管网数据导入](https://example.com/video/data_import)
- [爆管分析实战](https://example.com/video/burst_analysis)
- [移动端巡检](https://example.com/video/mobile_inspection)

### 案例研究
- [XX市给水管网数字化改造项目](case_studies/city_water.md)
- [XX区燃气管网安全管理平台](case_studies/gas_safety.md)
- [XX新区综合管廊智慧运维系统](case_studies/utility_tunnel.md)

---

<div align="center">

**⭐ 如果这个项目对您有帮助，请给个 Star！⭐**

**让城市地下管网管理更智能、更高效！**

Made with ❤️ by UGIMS Development Team

[🏠 首页](https://github.com/yourusername/UGIMS) | 
[📖 文档](docs/) | 
[🐛 反馈](https://github.com/yourusername/UGIMS/issues) | 
[💬 讨论](https://github.com/yourusername/UGIMS/discussions)

</div>
